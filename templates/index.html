<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì²­ëƒ ë¦¬ | ìµœì¢… MVP ë°ëª¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .screen { display: none; padding-bottom: 80px; }
        .screen.active { display: block; animation: fadeIn .3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .filter-active { background: #374151; color: #fff; border-color: #374151; }
        .vh-safe { min-height: 100svh; }
        .favorite-btn.favorited { color: #ef4444; }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-btn.active { color: #4f46e5; }
        .fab-kakao { position: fixed; bottom: 100px; right: 20px; z-index: 50; width: 60px; height: 60px; background-color: #FEE500; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease-in-out; }
        .fab-kakao:hover { transform: scale(1.05); }
        .fab-kakao-text { font-weight: 900; color: #191919; font-size: 14px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; max-width: 90%; width: 400px; animation: fadeIn .3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 flex justify-center">
    <div id="appContainer" class="max-w-lg w-full bg-white vh-safe shadow-2xl relative">

        <div id="homeScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-xl font-bold text-indigo-600">ì²­ëƒ ë¦¬ ğŸ“</h1>
                    <div class="flex items-center space-x-4 text-gray-600">
                        <button onclick="showMessage('ì•Œë¦¼ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')"><i class="ph ph-bell text-2xl"></i></button>
                        <button onclick="showCartModal()"><i class="ph ph-shopping-cart text-2xl"></i></button>
                    </div>
                </div>
                <div class="relative">
                    <input id="homeSearchInput" type="text" placeholder="ê°€ê²Œ ì´ë¦„ì´ë‚˜ ìƒí’ˆì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”!"
                           class="w-full pl-10 pr-4 py-3 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xl"></i>
                </div>
            </header>
            <nav class="p-4 grid grid-cols-4 gap-4 text-center">
                <button onclick="showScreen('mapScreen')" class="nav-button flex flex-col items-center justify-center space-y-2 p-2 rounded-lg hover:bg-indigo-50 transition-colors">
                    <div class="nav-icon w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center"><i class="ph ph-map-trifold text-3xl text-indigo-600"></i></div>
                    <span class="font-semibold text-gray-700 text-sm">ì‹œì¥ ì§€ë„</span>
                </button>
                <button onclick="showScreen('categoryListScreen', 'all')" class="nav-button flex flex-col items-center justify-center space-y-2 p-2 rounded-lg hover:bg-orange-50 transition-colors">
                    <div class="nav-icon w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center"><i class="ph ph-storefront text-3xl text-orange-600"></i></div>
                    <span class="font-semibold text-gray-700 text-sm">ê°€ê²Œ/ìƒí’ˆ</span>
                </button>
                <button onclick="showScreen('pickupScreen')" class="nav-button flex flex-col items-center justify-center space-y-2 p-2 rounded-lg hover:bg-teal-50 transition-colors">
                    <div class="nav-icon w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center"><i class="ph ph-qr-code text-3xl text-teal-600"></i></div>
                    <span class="font-semibold text-gray-700 text-sm">í”½ì—… ì£¼ë¬¸</span>
                </button>
                <button onclick="showScreen('smartShoppingScreen')" class="nav-button flex flex-col items-center justify-center space-y-2 p-2 rounded-lg hover:bg-sky-50 transition-colors">
                    <div class="nav-icon w-16 h-16 bg-sky-100 rounded-full flex items-center justify-center"><i class="ph ph-chats-circle text-3xl text-sky-600"></i></div>
                    <span class="font-semibold text-gray-700 text-sm">ìŠ¤ë§ˆíŠ¸ ì¥ë³´ê¸°</span>
                </button>
            </nav>
            <hr class="my-2 border-gray-100 border-4">
            <section class="p-4">
                <h2 class="text-lg font-bold text-gray-800 mb-4">ì–´ë–¤ ì¢…ë¥˜ë¥¼ ì°¾ìœ¼ì„¸ìš”?</h2>
                <div class="grid grid-cols-5 gap-4 text-center">
                    <button onclick="showScreen('categoryListScreen', 'ì •ìœ¡ì ')" class="flex flex-col items-center space-y-2"><div class="w-full h-16 flex items-center justify-center bg-red-100 rounded-lg shadow-sm text-4xl">ğŸ¥©</div><span class="text-xs font-medium">ì •ìœ¡</span></button>
                    <button onclick="showScreen('categoryListScreen', 'ìˆ˜ì‚°ë¬¼')" class="flex flex-col items-center space-y-2"><div class="w-full h-16 flex items-center justify-center bg-blue-100 rounded-lg shadow-sm text-4xl">ğŸŸ</div><span class="text-xs font-medium">ìˆ˜ì‚°</span></button>
                    <button onclick="showScreen('categoryListScreen', 'ì²­ê³¼ë¬¼')" class="flex flex-col items-center space-y-2"><div class="w-full h-16 flex items-center justify-center bg-green-100 rounded-lg shadow-sm text-4xl">ğŸ¥¬</div><span class="text-xs font-medium">ì²­ê³¼/ì•¼ì±„</span></button>
                    <button onclick="showScreen('categoryListScreen', 'ê°€ê³µì‹í’ˆ')" class="flex flex-col items-center space-y-2"><div class="w-full h-16 flex items-center justify-center bg-yellow-100 rounded-lg shadow-sm text-4xl">ğŸš</div><span class="text-xs font-medium">ë°˜ì°¬</span></button>
                    <button onclick="showScreen('categoryListScreen', 'ìŒì‹ì (í•œì‹)')" class="flex flex-col items-center space-y-2"><div class="w-full h-16 flex items-center justify-center bg-purple-100 rounded-lg shadow-sm text-4xl">ğŸ²</div><span class="text-xs font-medium">ìŒì‹ì </span></button>
                </div>
            </section>
        </div>

        <div id="categoryListScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center">
                    <button onclick="showScreen('homeScreen')" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 id="categoryTitle" class="text-xl font-bold text-gray-800"></h1>
                </div>
            </header>
            <div class="p-4 flex items-center space-x-2 border-b overflow-x-auto">
                <i class="ph ph-faders-horizontal text-xl text-gray-600"></i>
                <button class="category-sort-btn px-4 py-2 text-sm font-semibold border rounded-full filter-active whitespace-nowrap" data-sort="default">ê¸°ë³¸ ìˆœ</button>
                <button class="category-sort-btn px-4 py-2 text-sm font-semibold border rounded-full whitespace-nowrap" data-sort="orders">ì£¼ë¬¸ ë§ì€ ìˆœ</button>
                <button class="category-sort-btn px-4 py-2 text-sm font-semibold border rounded-full whitespace-nowrap" data-sort="rating">ë³„ì  ë†’ì€ ìˆœ</button>
            </div>
            <main id="categoryStoreListContainer" class="p-4 space-y-4"></main>
        </div>

        <div id="storeDetailScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center">
                    <button id="backToCategoryBtn" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 id="storeDetailTitle" class="text-xl font-bold text-gray-800 flex-1"></h1>
                    <button id="detailFavoriteBtn" class="p-2 text-gray-400 favorite-btn"><i class="ph ph-heart text-3xl"></i></button>
                </div>
            </header>
            <main class="p-4">
                <div id="storeDetailInfo" class="mb-6"></div>
                <hr>
                <h2 class="text-lg font-bold text-gray-800 my-4">ìƒí’ˆ ëª©ë¡</h2>
                <div id="storeProductListContainer" class="space-y-4"></div>
                <hr>
                <h2 class="text-lg font-bold text-gray-800 my-4">ë°©ë¬¸ì ë¦¬ë·°</h2>
                <div id="storeReviewsContainer" class="space-y-4"></div>
            </main>
        </div>

        <div id="smartShoppingScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center mb-4">
                    <button onclick="showScreen('homeScreen')" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 class="text-xl font-bold text-gray-800">ìŠ¤ë§ˆíŠ¸ ì¥ë³´ê¸°</h1>
                </div>
                 <div class="relative">
                    <input id="smartSearchInput" type="text" placeholder="ì˜ˆ: ê³ ë“±ì–´, ì‚¼ê²¹ì‚´, ê¹€ì¹˜"
                           class="w-full pl-10 pr-4 py-3 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xl"></i>
                </div>
            </header>
            <main class="p-4">
                <div id="myRecipesContainer" class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-gray-800">ë‚˜ë§Œì˜ ë ˆì‹œí”¼</h2>
                        <button onclick="showRecipeModal()" class="text-sm bg-indigo-100 text-indigo-700 font-semibold px-3 py-1 rounded-lg">+ ìƒˆ ë ˆì‹œí”¼ ì¶”ê°€</button>
                    </div>
                    <div id="myRecipesList" class="space-y-2"></div>
                </div>
                <hr class="my-4">
                <div id="smartSearchResultsContainer"></div>
            </main>
        </div>

        <div id="recipeModalScreen" class="screen bg-gray-50">
             <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center">
                    <button onclick="showScreen('smartShoppingScreen')" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 id="recipeModalTitle" class="text-xl font-bold text-gray-800">ìƒˆ ë ˆì‹œí”¼ ì¶”ê°€</h1>
                </div>
            </header>
            <main class="p-4">
                <input type="hidden" id="recipeIdInput">
                <div class="mb-4">
                    <label for="recipeNameInput" class="block text-sm font-medium text-gray-700 mb-1">ë ˆì‹œí”¼ ì´ë¦„</label>
                    <input type="text" id="recipeNameInput" placeholder="ì˜ˆ: ìš°ë¦¬ì§‘ ê¹€ì¹˜ì°Œê°œ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <h3 class="font-semibold mb-2">ì¬ë£Œ ëª©ë¡</h3>
                <div id="recipeIngredientsContainer" class="space-y-2"></div>
                <button id="addIngredientBtn" class="w-full mt-2 text-sm text-indigo-600 font-semibold p-2 bg-indigo-50 rounded-lg hover:bg-indigo-100">+ ì¬ë£Œ ì¶”ê°€í•˜ê¸°</button>
                <div class="mt-8 flex space-x-2">
                    <button id="deleteRecipeBtn" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 hidden">ì‚­ì œ</button>
                    <button id="saveRecipeBtn" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">ì €ì¥í•˜ê¸°</button>
                </div>
            </main>
        </div>

        <div id="pickupScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center">
                    <button onclick="showScreen('homeScreen')" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 class="text-xl font-bold text-gray-800">í”½ì—… ì£¼ë¬¸</h1>
                </div>
            </header>
            <main id="pickupScreenMain" class="p-6"></main>
        </div>
        
        <div id="myOrdersScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b"><h1 class="text-xl font-bold text-gray-800 text-center">ì£¼ë¬¸ ë‚´ì—­</h1></header>
            <main class="p-4 space-y-4"></main>
        </div>

        <div id="recentItemsScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b"><h1 class="text-xl font-bold text-gray-800 text-center">ìµœê·¼ ë³¸ ìƒí’ˆ</h1></header>
            <p class="p-10 text-center text-gray-500">ìµœê·¼ ë³¸ ìƒí’ˆ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
        <div id="favoritesScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b"><h1 class="text-xl font-bold text-gray-800 text-center">ì°œí•œ ê°€ê²Œ</h1></header>
            <main class="p-4 space-y-4"></main>
        </div>

        <div id="mapScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center">
                    <button onclick="showScreen('homeScreen')" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 class="text-xl font-bold text-gray-800">ì‹œì¥ ì§€ë„</h1>
                    <div class="ml-auto flex items-center gap-2">
                        <button onclick="showPromptBox('URL ì„¤ì •', 'ì‹œì¥ ì§€ë„ URLì„ ì…ë ¥í•˜ì„¸ìš”', setMarketMapUrl)" class="px-3 py-1.5 rounded-md border text-sm text-gray-700 hover:bg-gray-50">URL ì„¤ì •</button>
                        <a id="openMapNewTab" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm hover:bg-indigo-700">ìƒˆ íƒ­</a>
                    </div>
                </div>
            </header>
            <div id="mapLoading" class="p-6 flex items-center justify-center text-gray-500">
                <i class="ph ph-circle-notch animate-spin text-2xl mr-2"></i> ë¡œë”© ì¤‘â€¦
            </div>
            <iframe id="marketMapFrame" title="ì‹œì¥ ì§€ë„" class="w-full" style="border:0; height: calc(100svh - 65px - 80px); display:none;" referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe>
        </div>
        
        <div id="modalContainer"></div>

        <a href="https://pf.kakao.com/_xgGdxmn" target="_blank" class="fab-kakao">
             <span class="fab-kakao-text">TALK</span>
        </a>

        <footer class="bottom-nav fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full grid grid-cols-4 text-center bg-white border-t border-gray-200 z-20">
            <button data-screen="recentItemsScreen" class="nav-btn p-4 flex flex-col items-center justify-center text-gray-500"><i class="ph ph-clock-counter-clockwise text-2xl"></i><span class="text-xs mt-1">ìµœê·¼ ë³¸ ìƒí’ˆ</span></button>
            <button data-screen="homeScreen" class="nav-btn p-4 flex flex-col items-center justify-center text-gray-500 active"><i class="ph ph-house text-2xl"></i><span class="text-xs mt-1">í™ˆ</span></button>
            <button data-screen="favoritesScreen" class="nav-btn p-4 flex flex-col items-center justify-center text-gray-500"><i class="ph ph-heart text-2xl"></i><span class="text-xs mt-1">ì°œ</span></button>
            <button data-screen="myOrdersScreen" class="nav-btn p-4 flex flex-col items-center justify-center text-gray-500"><i class="ph ph-receipt text-2xl"></i><span class="text-xs mt-1">ë‚´ ì£¼ë¬¸</span></button>
        </footer>
    </div>

<script>
(() => {
    // ==================== ë°ì´í„° ë° ê¸°ë³¸ ìƒíƒœ ====================
    const marketData = [
        {"ê³ ìœ ID":0,"ê°€ê²Œì´ë¦„":"ìˆ˜í¬ê³¼ì¼","ê°€ê²Œë¶„ë¥˜":"ì²­ê³¼ë¬¼","main_product":"ê³¶ê°,ë”¸ê¸°,ë ˆëª¬,ë§ê³ ,ë©œë¡ ,ë°”ë‚˜ë‚˜,ë°°,ë³µìˆ­ì•„,ì‚¬ê³¼,ìƒ¤ì¸ë¨¸ìŠ¤ì¼“,ìˆ˜ë°•,ì”¨ì—†ëŠ”ìˆ˜ë°•,ì˜¤ëœì§€,ì˜¤ë Œì§€,ìë‘,ì°¸ì™¸,ì²´ë¦¬,í‚¤ìœ„,í† ë§ˆí† ,í¬ë„"},
        {"ê³ ìœ ID":1,"ê°€ê²Œì´ë¦„":"ì•ˆë™ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ì²­ê³¼ë¬¼","main_product":"ê·¤,ë”¸ê¸°,ë©œë¡ ,ë°©ìš¸í† ë§ˆí† ,ì‚¬ê³¼,ìˆ˜ë°•,í™ì‹œ"},
        {"ê³ ìœ ID":2,"ê°€ê²Œì´ë¦„":"ì†Œë¬¸ë‚œë°˜ì°¬","ê°€ê²Œë¶„ë¥˜":"ê°€ê³µì‹í’ˆ","main_product":"ê°ˆì¹˜ì†ì “,ê²Œì¥,ëª…ë€ì “,ìƒˆìš°ì¥,ì „ë³µì¥,ê¹€ì¹˜"},
        {"ê³ ìœ ID":3,"ê°€ê²Œì´ë¦„":"í•œì–‘ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":"ê¹»ì),ëŒ€íŒŒ,ë²„ì„¯(ëŠíƒ€ë¦¬,ìƒˆì†¡ì´),ì‹œê¸ˆì¹˜,ìŒˆì±„ì†Œ(ìƒì¶”,ì–‘íŒŒ,ìŒ€"},
        {"ê³ ìœ ID":4,"ê°€ê²Œì´ë¦„":"ëŒ€ë™ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ì²­ê³¼ë¬¼","main_product":"ê±°ë´‰,ë©œë¡ ,ë³µìˆ­ì•„,ë¸”ë£¨ë² ë¦¬,ì‚¬ê³¼,ìë‘,ìº ë²¨í¬ë„"},
        {"ê³ ìœ ID":5,"ê°€ê²Œì´ë¦„":"íƒœì˜ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ì²­ê³¼ë¬¼","main_product":"ë³µìˆ­ì•„,ìˆ˜ë°•,ìë‘,ì°¸ì™¸,ì²œë„ë³µìˆ­ì•„,í¬ë„"},
        {"ê³ ìœ ID":7,"ê°€ê²Œì´ë¦„":"ì¼í˜¸ì²­ê³¼","ê°€ê²Œë¶„ë¥˜":"ì²­ê³¼ë¬¼","main_product":"ê·¤,ë§ê³ ,ë©œë¡ ,ë°©ìš¸í† ë§ˆí† ,ìˆ˜ë°•,ì°¸ì™¸,í† ë§ˆí† ,í¬ë„"},
        {"ê³ ìœ ID":8,"ê°€ê²Œì´ë¦„":"ì²­ë„ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":"ê³ ì¶”,ê¹»ì,ë§ˆëŠ˜,ë¶€ì¶”,ì• í˜¸ë°•,ì–‘íŒŒ,ì˜¤ì´,ìª½íŒŒ,í˜¸ë°•ì"},
        {"ê³ ìœ ID":9,"ê°€ê²Œì´ë¦„":"ì „êµ­ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ì²­ê³¼ë¬¼","main_product":"ë§ê³ ìŠ¤í‹´,ë³µìˆ­ì•„,ë¸”ë£¨ë² ë¦¬,ì˜¤ë Œì§€,ìë‘,ì²´ë¦¬,íŒŒì¸ì• í”Œ"},
        {"ê³ ìœ ID":10,"ê°€ê²Œì´ë¦„":"ë§êµ¬ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":"ê°ì,ê³ êµ¬ë§ˆ,ê³ ì¶”,ëŒ€íŒŒ,ë²„ì„¯,ìƒì¶”,ì˜¤ì´,í˜¸ë°•,ìŒ€"},
        {"ê³ ìœ ID":11,"ê°€ê²Œì´ë¦„":"ì¼í’ˆìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":"ê°ì,ê³ êµ¬ë§ˆ,ê³ ì¶”,ë‹¹ê·¼,ë§ˆëŠ˜,ë°°ì¶”,ìƒì¶”,ìƒê°•,ì–‘íŒŒ,ì˜¤ì´"},
        {"ê³ ìœ ID":12,"ê°€ê²Œì´ë¦„":"ì§€ë¦¬ì‚°","ê°€ê²Œë¶„ë¥˜":"í•œì•½ì¬","main_product":""},
        {"ê³ ìœ ID":13,"ê°€ê²Œì´ë¦„":"ì¤‘ì•™ì•¼ì±„","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":""},
        {"ê³ ìœ ID":14,"ê°€ê²Œì´ë¦„":"ì‚¼í™”ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":""},
        {"ê³ ìœ ID":15,"ê°€ê²Œì´ë¦„":"ì‹ í˜„ëŒ€ìƒíšŒ","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":""},
        {"ê³ ìœ ID":16,"ê°€ê²Œì´ë¦„":"ì‚¼ì²œë¦¬ìì „ê±°","ê°€ê²Œë¶„ë¥˜":"ì„œë¹„ìŠ¤","main_product":"ì„±ì¸ìš©ìì „ê±°,ì–´ë¦°ì´ìì „ê±°,ìì „ê±°,ìì „ê±°ìš©í’ˆ,í—¬ë©§"},
        {"ê³ ìœ ID":17,"ê°€ê²Œì´ë¦„":"ìš°ë¦¬ë™ë„¤DCì•„ìš¸ë › ì²­ëŸ‰ë¦¬ì ","ê°€ê²Œë¶„ë¥˜":"ìƒí™œìš©í’ˆ(ì¡í™”)","main_product":"ê°ì¢…ìˆ˜ì €,ê³ ë¬´ì¥ê°‘,ëƒ„ë¹„,ë³‘,ìˆ˜ì„¸ë¯¸,ì “ê°€ë½,ì£¼ê±±,ì²­ì†Œë„êµ¬,í”„ë¼ì´íŒ¬"},
        {"ê³ ìœ ID":18,"ê°€ê²Œì´ë¦„":"í•œêµ­í† ì¢…ë¬¼ì‚°","ê°€ê²Œë¶„ë¥˜":"í•œì•½ì¬","main_product":"ê·€ë¦¬,ë…¹ìš©,ë‹¹ê·€,ì‚°ìˆ˜ìœ ,ì‘ë‘ì½©,ì¹¡ì¦™,í—›ê°œë‚˜ë¬´"},
        {"ê³ ìœ ID":19,"ê°€ê²Œì´ë¦„":"ë¹…í† ë¦¬ê°€ë°©","ê°€ê²Œë¶„ë¥˜":"ìƒí™œìš©í’ˆ(ì¡í™”)","main_product":"ë³‘,ì—¬í–‰ìš©ê°€ë°©,ì£¼ê±±,ì§€ê°‘,ì²­ì†Œë„êµ¬,ìºë¦¬ì–´,í•™ìƒìš©ë°±íŒ©,í•¸ë“œë°±"},
        {"ê³ ìœ ID":20,"ê°€ê²Œì´ë¦„":"í¬ì²œë†ì¥","ê°€ê²Œë¶„ë¥˜":"ì •ìœ¡ì ","main_product":"ê°€ë¸Œë¦¬ì‚´,ë‹­ê°ˆë¹„,ë¼ì§€ê°ˆë¹„,ë¼ì§€ë¶ˆê³ ê¸°,ë–¡ê°ˆë¹„,ëª©ì‚´,ì‚¼ê²¹ì‚´,ì†Œê³ ê¸°êµ­ê±°ë¦¬,ì†Œê³ ê¸°ë“±ì‹¬,ì†Œë¶ˆê³ ê¸°,ì˜¤ë¦¬ê³ ê¸°,í•­ì •ì‚´"},
        {"ê³ ìœ ID":21,"ê°€ê²Œì´ë¦„":"í•œì´ˆí•œì˜ì›","ê°€ê²Œë¶„ë¥˜":"ì„œë¹„ìŠ¤","main_product":"ëœ¸,ë¶€í•­,ì™•ì‚°ë¡œ,ì²´ì§ˆê°œì„ ,ì¹¨ìˆ ,í•œì•½ì²˜ë°©"},
        {"ê³ ìœ ID":130,"ê°€ê²Œì´ë¦„":"ê²½ë™í•¨í¥ëƒ‰ë©´","ê°€ê²Œë¶„ë¥˜":"ìŒì‹ì (í•œì‹)","main_product":"ê°ˆë¹„íƒ•,ë§Œë‘,ë¬¼ëƒ‰ë©´,ë¹„ë¹”ëƒ‰ë©´,ìˆ˜ìœ¡,íšŒëƒ‰ë©´,ê¹€ì¹˜"},
        {"ê³ ìœ ID":137,"ê°€ê²Œì´ë¦„":"ê·¸ì‹œì ˆê·¸ë§›","ê°€ê²Œë¶„ë¥˜":"ìŒì‹ì (ì œê³¼ì œë¹µ)","main_product":"ê³ ë¡œì¼€,ê½ˆë°°ê¸°,ë„ë„ˆì¸ ,ë§˜ëª¨ìŠ¤ë¹µ,ì†Œì‹œì§€ë¹µ,ì°ë¹µ,ì°¹ìŒ€ë„ë„›"},
        {"ê³ ìœ ID":81,"ê°€ê²Œì´ë¦„":"ì„±í˜„ë¬¼ì‚°","ê°€ê²Œë¶„ë¥˜":"ë†ì‚°ë¬¼","main_product":"ë…¹ìš©,ë‹¹ê·€,ë”ë•,ë„ë¼ì§€,ì‘¥,ì˜¤ë¯¸ì,ì¸ì‚¼,ì¹¡,í™ì‚¼,ìŒ€"}
    ];
    
    const storeData = marketData.map(store => {
        const productNames = store.main_product ? store.main_product.split(',') : [];
        const mainTags = productNames.slice(0, 2).map(tag => `#${tag.trim()}`).filter(tag => tag !== '#');
        const products = productNames.map((productName, index) => {
            if (!productName.trim()) return null;
            const cleanName = productName.trim().replace(/[()]/g, '');
            return {
                id: `${store.ê³ ìœ ID}-${index}`, name: cleanName,
                price: Math.floor(Math.random() * (300 - 50) + 50) * 100,
                img: `https://placehold.co/100x100/E0E7FF/4338CA?text=${encodeURIComponent(cleanName.charAt(0))}`
            };
        }).filter(p => p !== null);
        return {
            id: store.ê³ ìœ ID, name: store.ê°€ê²Œì´ë¦„, category: store.ê°€ê²Œë¶„ë¥˜,
            mainTags: mainTags, rating: (Math.random() * (5.0 - 4.0) + 4.0).toFixed(1),
            orders: Math.floor(Math.random() * 500) + 10, reviews: [], products: products
        };
    });
    
    let shoppingCart = {};
    let currentCategorySort = 'default';
    let favoriteStores = [];
    let completedOrders = []; 
    let userRecipes = [];
    const DEFAULT_MAP_URL = 'https://transcendent-crisp-6ebea8.netlify.app/';

    // ==================== ì„œë²„ í†µì‹  í•¨ìˆ˜ ====================
    async function sendOrderToServer(orderData) {
        try {
            const response = await fetch('/api/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            if (!response.ok) throw new Error((await response.json()).message || 'Server Error');
            return await response.json();
        } catch (error) {
            console.error("Server submission failed:", error);
            throw error;
        }
    }

    // ==================== UI HELPER FUNCTIONS ====================
    function showMessage(message) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content text-center">
                <p class="text-gray-800 text-lg mb-6">${message}</p>
                <button onclick="this.closest('.modal-overlay').remove()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">í™•ì¸</button>
            </div>`;
        document.getElementById('modalContainer').appendChild(modal);
    }

    function showPromptBox(title, message, callback) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">${title}</h3>
                <p class="text-gray-600 mb-4">${message}</p>
                <input type="text" id="promptInput" value="${getStoredMapUrl()}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                <div class="flex justify-end space-x-2">
                    <button onclick="this.closest('.modal-overlay').remove()" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">ì·¨ì†Œ</button>
                    <button id="promptConfirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">í™•ì¸</button>
                </div>
            </div>`;
        document.getElementById('modalContainer').appendChild(modal);
        document.getElementById('promptConfirmBtn').addEventListener('click', () => {
            const inputValue = document.getElementById('promptInput').value;
            callback(inputValue);
            modal.remove();
        });
    }
    
    // ==================== ì¥ë°”êµ¬ë‹ˆ ê´€ë ¨ í•¨ìˆ˜ë“¤ ====================
    function addToCart(storeId, storeName, productId, productName, price, img) {
        if (!shoppingCart[storeId]) {
            shoppingCart[storeId] = { storeName: storeName, items: {} };
        }
        if (shoppingCart[storeId].items[productId]) {
            shoppingCart[storeId].items[productId].quantity++;
        } else {
            shoppingCart[storeId].items[productId] = { name: productName, price: price, quantity: 1, img: img };
        }
    }

    function updateCartItemQuantity(storeId, productId, change) {
        if (shoppingCart[storeId] && shoppingCart[storeId].items[productId]) {
            const item = shoppingCart[storeId].items[productId];
            item.quantity += change;
            if (item.quantity <= 0) {
                delete shoppingCart[storeId].items[productId];
                if (Object.keys(shoppingCart[storeId].items).length === 0) {
                    delete shoppingCart[storeId];
                }
            }
        }
        const existingModal = document.querySelector('.modal-overlay');
        if (existingModal) {
            const currentUserId = existingModal.querySelector('#userIdInput')?.value || '';
            existingModal.remove();
            showCartModal();
            const newUserIdInput = document.querySelector('#userIdInput');
            if(newUserIdInput) newUserIdInput.value = currentUserId;
        }
    }

    function showCartModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        let cartItemsHtml = '', totalPrice = 0;
        const cartIsEmpty = Object.keys(shoppingCart).length === 0;

        if (cartIsEmpty) {
            cartItemsHtml = `<p class="text-center text-gray-500 py-10">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>`;
        } else {
            for (const storeId in shoppingCart) {
                const store = shoppingCart[storeId];
                let storeItemsHtml = '';
                for (const productId in store.items) {
                    const item = store.items[productId];
                    totalPrice += item.price * item.quantity;
                    storeItemsHtml += `
                        <div class="flex items-center py-3 border-b last:border-b-0">
                            <img src="${item.img}" alt="${item.name}" class="w-16 h-16 rounded-md mr-4">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-gray-600 font-bold">${item.price.toLocaleString()}ì›</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="cart-quantity-btn w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center" data-store-id="${storeId}" data-product-id="${productId}" data-change="-1">-</button>
                                <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                <button class="cart-quantity-btn w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center" data-store-id="${storeId}" data-product-id="${productId}" data-change="1">+</button>
                            </div>
                            <button class="ml-4 text-gray-400 hover:text-red-500 cart-delete-btn" data-store-id="${storeId}" data-product-id="${productId}"><i class="ph ph-x-circle text-2xl"></i></button>
                        </div>`;
                }
                cartItemsHtml += `
                    <div class="mb-4">
                        <button class="flex items-center font-bold text-lg mb-2 store-link-from-cart" data-store-id="${storeId}">
                            ${store.storeName} <i class="ph ph-caret-right ml-1"></i>
                        </button>
                        <div class="bg-gray-50 p-2 rounded-lg">${storeItemsHtml}</div>
                    </div>`;
            }
        }
        modal.innerHTML = `
            <div class="modal-content flex flex-col h-full max-h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">ì¥ë°”êµ¬ë‹ˆ</h3>
                    <button onclick="this.closest('.modal-overlay').remove()"><i class="ph ph-x text-2xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto pr-2">${cartItemsHtml}</div>
                <div class="border-t pt-4 mt-4">
                    <div class="mb-4">
                        <label for="userIdInput" class="block text-sm font-medium text-gray-700 mb-2">ì£¼ë¬¸ì ID</label>
                        <input type="text" id="userIdInput" placeholder="ë‚˜ì¤‘ì— QRì„ ì°¾ì„ ë•Œ ì‚¬ìš©í•  ID" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="text-right font-bold text-xl mb-4">
                        ì´ ê²°ì œê¸ˆì•¡: <span class="text-indigo-600">${totalPrice.toLocaleString()}ì›</span>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="checkoutBtn" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors ${cartIsEmpty ? 'opacity-50 cursor-not-allowed' : ''}" ${cartIsEmpty ? 'disabled' : ''}>
                            ê²°ì œí•˜ê³  QR ìƒì„±í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>`;
        document.getElementById('modalContainer').appendChild(modal);
        modal.addEventListener('click', e => {
            const quantityBtn = e.target.closest('.cart-quantity-btn');
            const deleteBtn = e.target.closest('.cart-delete-btn');
            const storeLink = e.target.closest('.store-link-from-cart');
            if (quantityBtn) {
                const { storeId, productId, change } = quantityBtn.dataset;
                updateCartItemQuantity(storeId, productId, parseInt(change));
            } else if (deleteBtn) {
                const { storeId, productId } = deleteBtn.dataset;
                updateCartItemQuantity(storeId, productId, -Infinity);
            } else if (storeLink) {
                modal.remove();
                showScreen('storeDetailScreen', { storeId: parseInt(storeLink.dataset.storeId), fromCategory: 'homeScreen' });
            }
        });
        if (!cartIsEmpty) {
            document.getElementById('checkoutBtn').addEventListener('click', handleCheckout);
        }
    }
    
    // ==================== ROUTING & RENDERING ====================
    function showScreen(screenId, param = null) {
        const appContainer = document.getElementById('appContainer');
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.screen === screenId));
        if (screenId === 'mapScreen') {
            appContainer.classList.remove('max-w-lg');
            applyMarketMapUrl(getStoredMapUrl());
        } else {
            appContainer.classList.add('max-w-lg');
        }
        switch (screenId) {
            case 'pickupScreen': renderPickupScreen(); break;
            case 'myOrdersScreen': renderMyOrdersScreen(); break;
            case 'favoritesScreen': renderFavoritesScreen(); break;
            case 'categoryListScreen': if (param) renderCategoryList(param); break;
            case 'storeDetailScreen': if (param) renderStoreDetail(param); break;
            case 'smartShoppingScreen':
                document.getElementById('smartSearchResultsContainer').innerHTML = '<p class="text-center text-gray-500 py-10">ì°¾ê³  ì‹¶ì€ ìƒí’ˆì„ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.<br>ë˜ëŠ” ì €ì¥ëœ ë ˆì‹œí”¼ë¥¼ ì´ìš©í•´ ë³´ì„¸ìš”.</p>';
                document.getElementById('smartSearchInput').value = '';
                renderMyRecipes();
                break;
            case 'recipeModalScreen': if (param) showRecipeModal(param.recipeId); break;
        }
    }

    function renderCategoryList(category) {
         const container = document.getElementById('categoryStoreListContainer');
         let stores;
         if (category === 'all') {
             document.getElementById('categoryTitle').textContent = 'ì „ì²´ ê°€ê²Œ';
             stores = [...storeData]; 
         } else {
             document.getElementById('categoryTitle').textContent = category;
             stores = storeData.filter(s => s.category === category);
         }
         container.innerHTML = '';
         switch (currentCategorySort) {
             case 'orders': stores.sort((a, b) => b.orders - a.orders); break;
             case 'rating': stores.sort((a, b) => b.rating - a.rating); break;
         }
         if (stores.length === 0) {
             container.innerHTML = `<p class="text-center text-gray-500 py-10">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
             return;
         }
         stores.forEach(store => {
             const isFavorited = favoriteStores.includes(store.id);
             const tagsHtml = store.mainTags.map(tag => `<span class="bg-gray-200 text-gray-700 text-xs font-medium mr-2 px-2 py-1 rounded">${tag}</span>`).join('');
             const card = document.createElement('div');
             card.className = 'flex items-start bg-white p-4 rounded-lg border border-gray-200 relative';
             card.innerHTML = `
                 <img src="https://placehold.co/100x100/E0E7FF/4338CA?text=${encodeURIComponent(store.name.charAt(0))}" alt="${store.name}" class="w-24 h-24 rounded-md mr-4 cursor-pointer store-link" data-store-id="${store.id}" data-from-category="${category}">
                 <div class="flex-1 cursor-pointer store-link" data-store-id="${store.id}" data-from-category="${category}">
                     <h3 class="font-bold text-lg text-gray-900">${store.name}</h3>
                     <div class="flex items-center text-sm text-gray-600 mt-1">
                         <i class="ph ph-star text-yellow-400 text-base mr-1"></i><span class="font-bold">${store.rating}</span><span class="mx-1">|</span><span>ë¦¬ë·° ${store.reviews.length}</span>
                     </div>
                     <div class="mt-2">${tagsHtml}</div>
                 </div>
                 <button class="absolute top-4 right-4 text-gray-400 favorite-btn ${isFavorited ? 'favorited' : ''}" data-store-id="${store.id}"><i class="ph ${isFavorited ? 'ph-heart-fill' : 'ph-heart'} text-3xl"></i></button>`;
             container.appendChild(card);
         });
    }

    function renderStoreDetail({ storeId, fromCategory }) {
        const store = storeData.find(s => s.id === storeId);
        if (!store) return;
        const isFavorited = favoriteStores.includes(store.id);
        const favBtn = document.getElementById('detailFavoriteBtn');
        document.getElementById('storeDetailTitle').textContent = store.name;
        document.getElementById('backToCategoryBtn').onclick = () => showScreen(fromCategory === 'favoritesScreen' ? 'favoritesScreen' : fromCategory === 'smartShoppingScreen' ? 'smartShoppingScreen' : 'categoryListScreen', fromCategory);
        favBtn.dataset.storeId = store.id;
        favBtn.className = `p-2 text-gray-400 favorite-btn ${isFavorited ? 'favorited' : ''}`;
        favBtn.innerHTML = `<i class="ph ${isFavorited ? 'ph-heart-fill' : 'ph-heart'} text-3xl"></i>`;
        document.getElementById('storeDetailInfo').innerHTML = `<div class="flex items-center"><img src="https://placehold.co/120x120/E0E7FF/4338CA?text=${encodeURIComponent(store.name.charAt(0))}" alt="${store.name}" class="w-28 h-28 rounded-lg mr-4"><div><h2 class="text-2xl font-bold">${store.name}</h2><div class="flex items-center text-lg text-gray-600 mt-2"><i class="ph ph-star-fill text-yellow-400 text-2xl mr-1"></i><span class="font-bold text-2xl">${store.rating}</span></div><p class="text-gray-500 mt-1">ì£¼ë¬¸ìˆ˜ ${store.orders.toLocaleString()}</p></div></div>`;
        const productListContainer = document.getElementById('storeProductListContainer');
        productListContainer.innerHTML = '';
        if (store.products && store.products.length > 0) {
            store.products.forEach(product => {
                const productEl = document.createElement('div');
                productEl.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-lg';
                productEl.innerHTML = `
                    <div class="flex items-center">
                        <img src="${product.img}" alt="${product.name}" class="w-16 h-16 rounded-md mr-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">${product.name}</h4>
                            <p class="text-indigo-600 font-bold mt-1">${product.price.toLocaleString()}ì›</p>
                        </div>
                    </div>
                    <button class="add-to-cart-btn px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700" data-store-id="${store.id}" data-store-name="${store.name}" data-product-id="${product.id}" data-product-name="${product.name}" data-product-price="${product.price}" data-product-img="${product.img}">ë‹´ê¸°</button>`;
                productListContainer.appendChild(productEl);
            });
        } else {
            productListContainer.innerHTML = `<p class="text-center text-gray-500 py-4">ë“±ë¡ëœ ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
        document.getElementById('storeReviewsContainer').innerHTML = `<p class="text-center text-gray-500">ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    }
    
    function renderPickupScreen() {
        const pickupScreenMain = document.getElementById('pickupScreenMain');
        pickupScreenMain.innerHTML = `
            <div class="border-b pb-6 mb-6">
                <p class="text-center text-gray-600">ì¥ë°”êµ¬ë‹ˆì—ì„œ ì£¼ë¬¸ì„ ì™„ë£Œí•˜ë©´ í”½ì—… QRì½”ë“œê°€ ì—¬ê¸°ì— ì¦‰ì‹œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            <div>
                 <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">ë˜ëŠ”, ì´ì „ ì£¼ë¬¸ ì¡°íšŒí•˜ê¸°</h3>
                <div class="mb-4">
                    <label for="viewUserIdInput" class="block text-sm font-medium text-gray-700 mb-2">ì£¼ë¬¸ì ID</label>
                    <input type="text" id="viewUserIdInput" placeholder="ì£¼ë¬¸ ì‹œ ì…ë ¥í•œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="fetchOrderQR()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">ë‚´ QRì½”ë“œ ì¡°íšŒí•˜ê¸°</button>
                <div id="fetchedQrContainer" class="mt-6"></div>
            </div>`;
    }

    function renderMyOrdersScreen() {
        const container = document.getElementById('myOrdersScreen').querySelector('main');
        container.innerHTML = '';
        if (completedOrders.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 p-10">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            return;
        }
        [...completedOrders].reverse().forEach(order => {
             let orderItemsHtml = '';
             for (const storeId in order.cart) {
                 const store = order.cart[storeId];
                 const itemNames = Object.values(store.items).map(item => `${item.name} ${item.quantity}ê°œ`).join('<br>');
                 orderItemsHtml += `<div class="mt-2"><h4 class="font-semibold text-lg text-gray-800">${store.storeName}</h4><p class="text-gray-600 pl-1">${itemNames}</p></div>`;
             }
             const orderCard = document.createElement('div');
             orderCard.className = 'bg-white p-4 rounded-lg border border-gray-200 shadow-sm';
             orderCard.innerHTML = `
                 <p class="text-sm text-gray-500 mb-2">${order.date} - í”½ì—…</p>
                 ${orderItemsHtml}
                 <div class="border-t mt-4 pt-3 flex justify-between items-center">
                     <span class="font-semibold text-gray-700">ê²°ì œê¸ˆì•¡</span>
                     <span class="font-bold text-lg text-gray-900">${order.totalPrice.toLocaleString()}ì›</span>
                 </div>`;
             container.appendChild(orderCard);
        });
    }

    function renderFavoritesScreen() {
        // ... (ì›ë³¸ ì½”ë“œì™€ ë™ì¼)
    }

    // ==================== í•µì‹¬ ì£¼ë¬¸ ë¡œì§ ====================
    async function handleCheckout() {
        const userIdInput = document.getElementById('userIdInput');
        if (!userIdInput) return;
        
        const userId = userIdInput.value.trim();
        if (!userId) return showMessage('ì£¼ë¬¸ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        const orderData = { userId, cart: shoppingCart, timestamp: new Date().toISOString() };
        try {
            await sendOrderToServer(orderData);
            
            const qrSummary = { userId: orderData.userId, items: {} };
            for (const storeId in orderData.cart) {
                const store = orderData.cart[storeId];
                qrSummary.items[store.storeName] = [];
                for (const productId in store.items) {
                    const item = store.items[productId];
                    qrSummary.items[store.storeName].push(`${item.name}(${item.quantity}ê°œ)`);
                }
            }
            const qrDataString = JSON.stringify(qrSummary);
            
            const totalPrice = Object.values(shoppingCart).map(s => Object.values(s.items).reduce((sum, item) => sum + (item.price * item.quantity), 0)).reduce((acc, val) => acc + val, 0);
            completedOrders.push({ ...orderData, totalPrice, date: new Date().toLocaleDateString('ko-KR') });
            
            shoppingCart = {};
            document.querySelector('.modal-overlay')?.remove();
            
            showScreen('pickupScreen');
            
            const pickupScreenMain = document.getElementById('pickupScreenMain');
            pickupScreenMain.innerHTML = `
                <div class="bg-gray-50 p-6 rounded-lg text-center">
                    <h2 class="text-lg font-semibold text-gray-800">í”½ì—… ì¤€ë¹„ ì™„ë£Œ!</h2>
                    <p class="text-gray-500 mt-1">ID: <span class="font-bold text-indigo-600">${userId}</span></p>
                    <div id="generated-qrcode" class="mt-4 flex justify-center"></div>
                    <p class="mt-4 text-sm">ì´ QRì½”ë“œë¥¼ í”½ì—… ì„¼í„°ì— ë³´ì—¬ì£¼ì„¸ìš”.</p>
                </div>`;
            new QRCode(document.getElementById('generated-qrcode'), { text: qrDataString, width: 200, height: 200 });
            
            const viewUserIdInput = document.getElementById('viewUserIdInput');
            if (viewUserIdInput) viewUserIdInput.value = userId;

        } catch (error) {
            showMessage(`ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }

    async function fetchOrderQR() {
        const pickupScreenMain = document.getElementById('pickupScreenMain');
        const userIdInput = pickupScreenMain.querySelector('#viewUserIdInput');
        if (!userIdInput) return;

        const userId = userIdInput.value.trim();
        if (!userId) return showMessage('ì¡°íšŒí•  ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        const fetchedQrContainer = pickupScreenMain.querySelector('#fetchedQrContainer');
        fetchedQrContainer.innerHTML = '<p class="text-center text-gray-500 p-4">ì„œë²„ì—ì„œ ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ëŠ” ì¤‘...</p>';
        try {
            const response = await fetch(`/api/get-order/${userId}`);
            const data = await response.json();
            if (data.success) {
                const order = data.order;
                const qrSummary = { userId: order.userId, items: {} };
                for (const storeId in order.cart) {
                    const store = order.cart[storeId];
                    qrSummary.items[store.storeName] = [];
                    for (const productId in store.items) {
                        const item = store.items[productId];
                        qrSummary.items[store.storeName].push(`${item.name}(${item.quantity}ê°œ)`);
                    }
                }
                const qrDataString = JSON.stringify(qrSummary);

                fetchedQrContainer.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-lg text-center">
                        <h2 class="text-lg font-semibold text-gray-800">ì£¼ë¬¸ ì •ë³´ í™•ì¸</h2>
                        <p class="text-gray-500 mt-1">ID: <span class="font-bold text-indigo-600">${order.userId}</span></p>
                        <div id="fetched-qrcode" class="mt-4 flex justify-center"></div>
                    </div>`;
                new QRCode(document.getElementById('fetched-qrcode'), { text: qrDataString, width: 200, height: 200 });
            } else {
                fetchedQrContainer.innerHTML = `<p class="text-center text-red-500 font-semibold p-4">${data.message}</p>`;
            }
        } catch (error) {
            fetchedQrContainer.innerHTML = `<p class="text-center text-red-500 font-semibold p-4">ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
        }
    }
    
    // ==================== ì§€ë„, ë ˆì‹œí”¼, ê¸°íƒ€ í•¨ìˆ˜ë“¤ ====================
    function getStoredMapUrl() { return localStorage.getItem('marketMapUrl') || DEFAULT_MAP_URL; }
    function setMarketMapUrl(url) { try { new URL(url); localStorage.setItem('marketMapUrl', url); applyMarketMapUrl(url); showMessage('ì§€ë„ URLì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');} catch (e) { showMessage('ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');} }
    function applyMarketMapUrl(url) {
        const frame = document.getElementById('marketMapFrame');
        const newTabLink = document.getElementById('openMapNewTab');
        const loading = document.getElementById('mapLoading');
        loading.style.display = 'flex';
        frame.style.display = 'none';
        frame.src = url;
        newTabLink.href = url;
    }
    function toggleFavorite(storeId) {
        // ... (ì›ë³¸ ì½”ë“œì™€ ë™ì¼)
    }
    // ... (ê¸°íƒ€ ëª¨ë“  í•¨ìˆ˜ë¥¼ ì—¬ê¸°ì— í¬í•¨)

    // ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™” ====================
    function setupAllEventListeners() {
        document.body.addEventListener('click', (e) => {
            const addToCartBtn = e.target.closest('.add-to-cart-btn');
            const favoriteBtn = e.target.closest('.favorite-btn');
            const storeLink = e.target.closest('.store-link');
            if (addToCartBtn) {
                const { storeId, storeName, productId, productName, productPrice, productImg } = addToCartBtn.dataset;
                addToCart(storeId, storeName, productId, productName, parseInt(productPrice), productImg);
                showMessage(`'${productName}' ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!`);
            } else if (favoriteBtn) {
                toggleFavorite(favoriteBtn.dataset.storeId);
            } else if (storeLink) {
                showScreen('storeDetailScreen', { storeId: parseInt(storeLink.dataset.storeId), fromCategory: storeLink.dataset.fromCategory });
            }
        });
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', (e) => showScreen(e.currentTarget.dataset.screen));
        });
        // ... (ê¸°íƒ€ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì—¬ê¸°ì— í¬í•¨)
    }

    window.showMessage = showMessage;
    window.showCartModal = showCartModal;
    window.showScreen = showScreen;
    window.fetchOrderQR = fetchOrderQR;
    window.showPromptBox = showPromptBox;
    window.setMarketMapUrl = setMarketMapUrl;

    document.addEventListener('DOMContentLoaded', () => {
        setupAllEventListeners();
        showScreen('homeScreen');
    });
})();
</script>
</body>
</html>
