<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>청냠리 | 최종 MVP 데모</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .screen { display: none; padding-bottom: 80px; }
        .screen.active { display: block; animation: fadeIn .3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .filter-active { background: #374151; color: #fff; border-color: #374151; }
        .vh-safe { min-height: 100svh; }
        .favorite-btn.favorited { color: #ef4444; }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-btn.active { color: #4f46e5; }
        .fab-kakao { position: fixed; bottom: 100px; right: 20px; z-index: 50; width: 60px; height: 60px; background-color: #FEE500; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease-in-out; }
        .fab-kakao:hover { transform: scale(1.05); }
        .fab-kakao-text { font-weight: 900; color: #191919; font-size: 14px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; max-width: 90%; width: 400px; animation: fadeIn .3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 flex justify-center">
    <div id="appContainer" class="max-w-lg w-full bg-white vh-safe shadow-2xl relative">

        <div id="homeScreen" class="screen">...</div>
        <div id="categoryListScreen" class="screen">...</div>
        <div id="storeDetailScreen" class="screen">...</div>
        <div id="smartShoppingScreen" class="screen">...</div>
        <div id="pickupScreen" class="screen">
             <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center">
                    <button onclick="showScreen('homeScreen')" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 class="text-xl font-bold text-gray-800">픽업 주문 확인</h1>
                </div>
            </header>
            <main id="pickupScreenMain" class="p-6">
                </main>
        </div>
        <div id="myOrdersScreen" class="screen">...</div>
        <div id="recentItemsScreen" class="screen">...</div>
        <div id="favoritesScreen" class="screen">...</div>
        <div id="mapScreen" class="screen">...</div>
        <div id="recipeModalScreen" class="screen bg-gray-50">...</div>

        <div id="modalContainer"></div>
        <a href="https://pf.kakao.com/_xgGdxmn" target="_blank" class="fab-kakao">...</a>
        <footer class="bottom-nav ...">...</footer>
    </div>

    <script>
    (() => {
        // ==================== 데이터 및 기본 상태 ====================
        const marketData = [
            {"고유ID":0,"가게이름":"수희과일","가게분류":"청과물","main_product":"곶감,딸기,레몬,망고,멜론,바나나,배,복숭아,사과,샤인머스켓,수박,씨없는수박,오랜지,오렌지,자두,참외,체리,키위,토마토,포도"},
            {"고유ID":1,"가게이름":"안동상회","가게분류":"청과물","main_product":"귤,딸기,멜론,방울토마토,사과,수박,홍시"},
            {"고유ID":2,"가게이름":"소문난반찬","가게분류":"가공식품","main_product":"갈치속젓,게장,명란젓,새우장,전복장,김치"},
            {"고유ID":3,"가게이름":"한양상회","가게분류":"농산물","main_product":"깻잎),대파,버섯(느타리,새송이),시금치,쌈채소(상추,양파,쌀"},
            {"고유ID":4,"가게이름":"대동상회","가게분류":"청과물","main_product":"거봉,멜론,복숭아,블루베리,사과,자두,캠벨포도"},
            {"고유ID":5,"가게이름":"태영상회","가게분류":"청과물","main_product":"복숭아,수박,자두,참외,천도복숭아,포도"},
            {"고유ID":7,"가게이름":"일호청과","가게분류":"청과물","main_product":"귤,망고,멜론,방울토마토,수박,참외,토마토,포도"},
            {"고유ID":8,"가게이름":"청도상회","가게분류":"농산물","main_product":"고추,깻잎,마늘,부추,애호박,양파,오이,쪽파,호박잎"},
            {"고유ID":9,"가게이름":"전국상회","가게분류":"청과물","main_product":"망고스틴,복숭아,블루베리,오렌지,자두,체리,파인애플"},
            {"고유ID":10,"가게이름":"말구상회","가게분류":"농산물","main_product":"감자,고구마,고추,대파,버섯,상추,오이,호박,쌀"},
            {"고유ID":16,"가게이름":"바다먹거리장터","가게분류":"수산물","main_product":"광어,꽃게,낙지,대게,랍스터,문어,연어,우럭,전복,조개,킹크랩,회,고등어"},
            {"고유ID":24,"가게이름":"신토불이 축산물직판장","가게분류":"정육점","main_product":"가브리살,갈비살,닭고기,돼지특수부위,항정살,목살,삼겹살,소갈비,소고기국거리,소고기등심,오리고기,한우특수부위,살치살"},
            {"고유ID":130,"가게이름":"경동함흥냉면","가게분류":"음식점(한식)","main_product":"갈비탕,만두,물냉면,비빔냉면,수육,회냉면,김치"},
            {"고유ID":132,"가게이름":"대박정육점","가게분류":"정육점","main_product":"돼지갈매기살,돼지갈비,목살,삼겹살,소갈비,소고기국거리,소고기등심,소꼬리,안심,한우특수부위,채끝"},
            {"고유ID":133,"가게이름":"우리축산","가게분류":"정육점","main_product":"양념갈비,대패삼겹살,삼겹살"},
            {"고유ID":34,"가게이름":"거북이젓갈","가게분류":"반찬/김치","main_product":"갈치속젓,꼴뚜기젓,낙지젓,명란젓,새우젓,어리굴젓,오징어젓,창난젓,김치"},
            {"고유ID":62,"가게이름":"금산인삼","가게분류":"가공식품","main_product":"더덕,도라지,산양삼,수삼,인삼,인삼주,홍삼액"},
            {"고유ID":137,"가게이름":"그시절그맛","가게분류":"음식점(제과제빵)","main_product":"고로케,꽈배기,도너츠,맘모스빵,소시지빵,찐빵,찹쌀도넛"},
            {"고유ID":81,"가게이름":"성현물산","가게분류":"농산물","main_product":"녹용,당귀,더덕,도라지,쑥,오미자,인삼,칡,홍삼,쌀"}
        ];
        
        const storeData = marketData.map(store => {
            const productNames = store.main_product ? store.main_product.split(',') : [];
            const mainTags = productNames.slice(0, 2).map(tag => `#${tag.trim()}`).filter(tag => tag !== '#');
            const products = productNames.map((productName, index) => {
                if (!productName.trim()) return null;
                const cleanName = productName.trim().replace(/[()]/g, '');
                return {
                    id: `${store.고유ID}-${index}`, name: cleanName,
                    price: Math.floor(Math.random() * (300 - 50) + 50) * 100,
                    img: `https://placehold.co/100x100/E0E7FF/4338CA?text=${encodeURIComponent(cleanName.charAt(0))}`
                };
            }).filter(p => p !== null);
            return {
                id: store.고유ID, name: store.가게이름, category: store.가게분류,
                mainTags: mainTags, rating: (Math.random() * (5.0 - 4.0) + 4.0).toFixed(1),
                orders: Math.floor(Math.random() * 500) + 10, reviews: [], products: products
            };
        });
        
        let shoppingCart = {};
        let currentCategorySort = 'default';
        let favoriteStores = [];
        let completedOrders = []; // 주문내역 화면을 위한 로컬 저장소
        let userRecipes = [];
        const DEFAULT_MAP_URL = 'https://transcendent-crisp-6ebea8.netlify.app/';

        // ==================== 서버 통신 함수 ====================
        async function sendOrderToServer(orderData) {
            try {
                // API 주소는 상대 경로로 지정하여 현재 도메인(Render 주소)을 기준으로 요청
                const response = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Server error');
                }
                return await response.json();
            } catch (error) {
                console.error("Server submission failed:", error);
                throw error;
            }
        }

        // ==================== UI HELPER FUNCTIONS ====================
        function showMessage(message) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content text-center">
                    <p class="text-gray-800 text-lg mb-6">${message}</p>
                    <button onclick="this.closest('.modal-overlay').remove()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">확인</button>
                </div>`;
            document.getElementById('modalContainer').appendChild(modal);
        }

        function showPromptBox(title, message, callback) {
            // ... (원본 코드와 동일)
        }

        // ==================== 장바구니 관련 함수들 ====================
        function addToCart(storeId, storeName, productId, productName, price, img) {
            if (!shoppingCart[storeId]) {
                shoppingCart[storeId] = { storeName: storeName, items: {} };
            }
            if (shoppingCart[storeId].items[productId]) {
                shoppingCart[storeId].items[productId].quantity++;
            } else {
                shoppingCart[storeId].items[productId] = { name: productName, price: price, quantity: 1, img: img };
            }
        }

        function updateCartItemQuantity(storeId, productId, change) {
            if (shoppingCart[storeId] && shoppingCart[storeId].items[productId]) {
                const item = shoppingCart[storeId].items[productId];
                item.quantity += change;
                if (item.quantity <= 0) {
                    delete shoppingCart[storeId].items[productId];
                    if (Object.keys(shoppingCart[storeId].items).length === 0) {
                        delete shoppingCart[storeId];
                    }
                }
            }
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                const currentUserId = existingModal.querySelector('#userIdInput')?.value || '';
                existingModal.remove();
                showCartModal();
                const newUserIdInput = document.querySelector('#userIdInput');
                if(newUserIdInput) newUserIdInput.value = currentUserId;
            }
        }

        function showCartModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            let cartItemsHtml = '', totalPrice = 0;
            const cartIsEmpty = Object.keys(shoppingCart).length === 0;

            if (cartIsEmpty) {
                cartItemsHtml = `<p class="text-center text-gray-500 py-10">장바구니가 비어 있습니다.</p>`;
            } else {
                for (const storeId in shoppingCart) {
                    const store = shoppingCart[storeId];
                    let storeItemsHtml = '';
                    for (const productId in store.items) {
                        const item = store.items[productId];
                        totalPrice += item.price * item.quantity;
                        storeItemsHtml += `
                            <div class="flex items-center py-3 border-b last:border-b-0">
                                <img src="${item.img}" alt="${item.name}" class="w-16 h-16 rounded-md mr-4">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${item.name}</p>
                                    <p class="text-gray-600 font-bold">${item.price.toLocaleString()}원</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="cart-quantity-btn w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center" data-store-id="${storeId}" data-product-id="${productId}" data-change="-1">-</button>
                                    <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                    <button class="cart-quantity-btn w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center" data-store-id="${storeId}" data-product-id="${productId}" data-change="1">+</button>
                                </div>
                                <button class="ml-4 text-gray-400 hover:text-red-500 cart-delete-btn" data-store-id="${storeId}" data-product-id="${productId}">
                                    <i class="ph ph-x-circle text-2xl"></i>
                                </button>
                            </div>`;
                    }
                    cartItemsHtml += `
                        <div class="mb-4">
                            <button class="flex items-center font-bold text-lg mb-2 store-link-from-cart" data-store-id="${storeId}">
                                ${store.storeName} <i class="ph ph-caret-right ml-1"></i>
                            </button>
                            <div class="bg-gray-50 p-2 rounded-lg">${storeItemsHtml}</div>
                        </div>`;
                }
            }
            modal.innerHTML = `
                <div class="modal-content flex flex-col h-full max-h-[80vh]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">장바구니</h3>
                        <button onclick="this.closest('.modal-overlay').remove()"><i class="ph ph-x text-2xl"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto pr-2">${cartItemsHtml}</div>
                    <div class="border-t pt-4 mt-4">
                        <div class="mb-4">
                            <label for="userIdInput" class="block text-sm font-medium text-gray-700 mb-2">주문자 ID</label>
                            <input type="text" id="userIdInput" placeholder="나중에 QR을 찾을 때 사용할 ID" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="text-right font-bold text-xl mb-4">
                            총 결제금액: <span class="text-indigo-600">${totalPrice.toLocaleString()}원</span>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button id="checkoutBtn" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors ${cartIsEmpty ? 'opacity-50 cursor-not-allowed' : ''}" ${cartIsEmpty ? 'disabled' : ''}>
                                결제하고 QR 생성하기
                            </button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modalContainer').appendChild(modal);
            modal.addEventListener('click', e => {
                const quantityBtn = e.target.closest('.cart-quantity-btn');
                const deleteBtn = e.target.closest('.cart-delete-btn');
                const storeLink = e.target.closest('.store-link-from-cart');
                if (quantityBtn) {
                    const { storeId, productId, change } = quantityBtn.dataset;
                    updateCartItemQuantity(storeId, productId, parseInt(change));
                } else if (deleteBtn) {
                    const { storeId, productId } = deleteBtn.dataset;
                    updateCartItemQuantity(storeId, productId, -Infinity);
                } else if (storeLink) {
                    modal.remove();
                    showScreen('storeDetailScreen', { storeId: parseInt(storeLink.dataset.storeId), fromCategory: 'homeScreen' });
                }
            });
            if (!cartIsEmpty) {
                document.getElementById('checkoutBtn').addEventListener('click', handleCheckout);
            }
        }
        
        // ==================== ⭐️핵심 주문 로직⭐️ ====================
        async function handleCheckout() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) return showMessage('주문자 ID를 입력해주세요.');

            const orderData = { userId, cart: shoppingCart, timestamp: new Date().toISOString() };
            try {
                // 1. 서버로 주문 정보 전송 및 영구 저장
                await sendOrderToServer(orderData);
                const qrDataString = JSON.stringify(orderData);
                
                // 2. 주문내역 화면을 위해 로컬에도 저장 (선택사항)
                const totalPrice = Object.values(shoppingCart).map(s => Object.values(s.items).reduce((sum, item) => sum + (item.price * item.quantity), 0)).reduce((acc, val) => acc + val, 0);
                completedOrders.push({ ...orderData, totalPrice, date: new Date().toLocaleDateString('ko-KR') });
                
                // 3. 장바구니 비우기 및 모달 닫기
                shoppingCart = {};
                document.querySelector('.modal-overlay')?.remove();
                
                // 4. "픽업 주문" 화면으로 전환
                showScreen('pickupScreen');
                
                // 5. "픽업 주문" 화면에 방금 생성한 QR코드 즉시 표시
                const pickupScreenMain = document.getElementById('pickupScreenMain');
                pickupScreenMain.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-lg text-center">
                        <h2 class="text-lg font-semibold text-gray-800">픽업 준비 완료!</h2>
                        <p class="text-gray-500 mt-1">ID: <span class="font-bold text-indigo-600">${userId}</span></p>
                        <div id="generated-qrcode" class="mt-4 flex justify-center"></div>
                        <p class="mt-4 text-sm">이 QR코드를 픽업 센터에 보여주세요.</p>
                    </div>`;
                new QRCode(document.getElementById('generated-qrcode'), { text: qrDataString, width: 200, height: 200 });

            } catch (error) {
                showMessage(`주문 처리 중 오류가 발생했습니다: ${error.message}`);
            }
        }
        
        // ==================== ROUTING & RENDERING ====================
        // (이하 모든 UI 렌더링 함수, 이벤트 리스너, 앱 초기화 코드는 원본과 동일하게 유지됩니다)
        // ...
    })();
    </script>
</body>
</html>
