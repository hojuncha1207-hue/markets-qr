<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>청냠리 | 최종 MVP 데모</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* CSS는 제공해주신 원본과 동일합니다. */
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .screen { display: none; padding-bottom: 80px; }
        .screen.active { display: block; animation: fadeIn .3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .filter-active { background: #374151; color: #fff; border-color: #374151; }
        .vh-safe { min-height: 100svh; }
        .favorite-btn.favorited { color: #ef4444; }
        .bottom-nav { box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-btn.active { color: #4f46e5; }
        .fab-kakao { position: fixed; bottom: 100px; right: 20px; z-index: 50; width: 60px; height: 60px; background-color: #FEE500; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease-in-out; }
        .fab-kakao:hover { transform: scale(1.05); }
        .fab-kakao-text { font-weight: 900; color: #191919; font-size: 14px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 400px; animation: fadeIn .3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 flex justify-center">
    <div id="appContainer" class="max-w-lg w-full bg-white vh-safe shadow-2xl relative">

        <div id="homeScreen" class="screen active">
            </div>

        <div id="categoryListScreen" class="screen">
            </div>

        <div id="storeDetailScreen" class="screen">
            </div>
        
        <div id="pickupScreen" class="screen">
            <header class="p-4 sticky top-0 bg-white z-10 border-b">
                <div class="flex items-center">
                    <button onclick="showScreen('homeScreen')" class="p-2 mr-2"><i class="ph ph-arrow-left text-2xl"></i></button>
                    <h1 class="text-xl font-bold text-gray-800">픽업 주문 완료</h1>
                </div>
            </header>
            <main id="pickupScreenMain" class="p-6">
                </main>
        </div>
        
        <div id="modalContainer"></div>
        </div>

    <script>
    (() => {
        // ==================== 데이터 및 기본 상태 ====================
        const marketData = [
            {"고유ID":0,"가게이름":"수희과일", "main_product":"곶감,딸기,레몬,망고,멜론,바나나,배,복숭아,사과,샤인머스켓,수박,씨없는수박,오랜지,오렌지,자두,참외,체리,키위,토마토,포도"},
            {"고유ID":1,"가게이름":"안동상회", "main_product":"귤,딸기,멜론,방울토마토,사과,수박,홍시"},
            // ... (제공해주신 모든 가게 데이터를 여기에 포함) ...
        ];
        
        const storeData = marketData.map(store => {
            const productNames = store.main_product ? store.main_product.split(',') : [];
            const mainTags = productNames.slice(0, 2).map(tag => `#${tag.trim()}`);
            const products = productNames.map((productName, index) => {
                if (!productName.trim()) return null;
                return {
                    id: `${store.고유ID}-${index}`, name: productName.trim(),
                    price: Math.floor(Math.random() * (300 - 50) + 50) * 100, // 데모용 랜덤 가격
                    img: `https://placehold.co/100x100/E0E7FF/4338CA?text=${encodeURIComponent(productName.trim().charAt(0))}`
                };
            }).filter(p => p !== null);
            return {
                id: store.고유ID, name: store.가게이름, category: store.가게분류,
                mainTags: mainTags, rating: (Math.random() * (5.0 - 4.0) + 4.0).toFixed(1),
                orders: Math.floor(Math.random() * 500) + 10, reviews: [], products: products
            };
        });
        
        let shoppingCart = {};
        let currentCategorySort = 'default';
        let favoriteStores = [];

        // ==================== 서버 통신 함수 ====================
        async function sendOrderToServer(orderData) {
            try {
                const response = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                if (!response.ok) throw new Error((await response.json()).message || 'Server Error');
                return await response.json();
            } catch (error) {
                console.error("Server submission failed:", error);
                throw error;
            }
        }

        // ==================== UI HELPER 및 모달 ====================
        function showMessage(message) { /* ... 원본 코드와 동일 ... */ }

        function showCartModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            let cartItemsHtml = '', totalPrice = 0;
            if (Object.keys(shoppingCart).length > 0) {
                for (const storeName in shoppingCart) {
                    const items = shoppingCart[storeName];
                    const itemDetails = items.map(item => {
                        totalPrice += item.price;
                        return `<p class="text-gray-600 text-sm">${item.name} - ${item.price.toLocaleString()}원</p>`;
                    }).join('');
                    cartItemsHtml += `<div class="bg-gray-50 p-3 rounded-lg mb-2"><p class="font-semibold text-gray-800 mb-1">${storeName}</p>${itemDetails}</div>`;
                }
            } else {
                 cartItemsHtml = `<p class="text-center text-gray-500 py-4">장바구니가 비어 있습니다.</p>`;
            }
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-bold mb-4">장바구니</h3>
                    <div class="mb-4">
                        <label for="userIdInput" class="block text-sm font-medium text-gray-700 mb-2">주문자 ID</label>
                        <input type="text" id="userIdInput" placeholder="나중에 QR을 찾을 때 사용할 ID" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="space-y-3 max-h-60 overflow-y-auto mb-4">${cartItemsHtml}</div>
                    <div class="text-right font-bold text-xl my-4 border-t pt-4">총 결제금액: <span class="text-indigo-600">${totalPrice.toLocaleString()}원</span></div>
                    <div class="flex flex-col space-y-2">
                        <button id="checkoutBtn" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700" ${totalPrice === 0 ? 'disabled' : ''}>결제하고 QR 생성하기</button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="w-full px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">닫기</button>
                    </div>
                </div>`;
            document.getElementById('modalContainer').appendChild(modal);
            if (totalPrice > 0) {
                document.getElementById('checkoutBtn').addEventListener('click', handleCheckout);
            }
        }
        
        // ==================== ⭐️ 핵심 주문/결제 로직 (수정됨) ⭐️ ====================
        async function handleCheckout() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) return showMessage('주문자 ID를 입력해주세요.');

            const orderData = { userId, cart: shoppingCart, timestamp: new Date().toISOString() };
            try {
                // 1. 서버로 주문 정보 전송 및 영구 저장
                await sendOrderToServer(orderData);
                const qrDataString = JSON.stringify(orderData);

                // 2. 장바구니 비우기 및 모달 닫기
                shoppingCart = {};
                document.querySelector('.modal-overlay')?.remove();
                
                // 3. '픽업 주문' 화면으로 전환
                showScreen('pickupScreen');
                
                // 4. '픽업 주문' 화면에 방금 생성한 QR코드 즉시 표시
                const pickupScreenMain = document.getElementById('pickupScreenMain');
                pickupScreenMain.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-lg text-center">
                        <h2 class="text-lg font-semibold text-gray-800">픽업 준비 완료!</h2>
                        <p class="text-gray-500 mt-1">ID: <span class="font-bold text-indigo-600">${userId}</span></p>
                        <div id="generated-qrcode" class="mt-4 flex justify-center"></div>
                        <p class="mt-4 text-sm">이 QR코드를 픽업 센터에 보여주세요.</p>
                    </div>`;
                new QRCode(document.getElementById('generated-qrcode'), { text: qrDataString, width: 200, height: 200 });
                
            } catch (error) {
                showMessage(`주문 처리 중 오류가 발생했습니다: ${error.message}`);
            }
        }
        
        // addToCart 함수는 shoppingCart 구조에 맞게 수정합니다.
        function addToCart(storeName, productName, price) {
           if (!shoppingCart[storeName]) shoppingCart[storeName] = [];
           shoppingCart[storeName].push({ name: productName, price: price });
           showMessage(`'${productName}' 상품을 장바구니에 담았습니다!`);
        }
        
        // ==================== 전역 함수 노출 및 이벤트 리스너 (복원됨) ====================
        // (showMessage, showCartModal 등 UI 관련 함수들은 여기에 포함됩니다)
        
        // ... (showScreen, renderCategoryList, renderStoreDetail 등 제공해주신 원본 코드의 모든 함수를 여기에 포함시켜야 합니다) ...
        
        // ==================== APP 초기화 ====================
        // (제공해주신 원본 코드의 setupAllEventListeners, DOMContentLoaded 이벤트 리스너를 여기에 포함시켜야 합니다)

    })();
    </script>
</body>
</html>
