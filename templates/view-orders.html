<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>내 주문 QR코드 확인</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f4f7f6; }
        .container { text-align: center; padding: 30px; background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; width: 90%; }
        input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 12px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>내 주문 정보 확인</h1>
        <input type="text" id="viewUserIdInput" placeholder="주문 시 입력한 ID를 입력하세요">
        <button onclick="fetchOrderQR()">주문 조회하기</button>
        <div id="order-container" style="margin-top: 20px;"></div>
    </div>
    <script>
        async function fetchOrderQR() {
            const container = document.getElementById('order-container');
            const userId = document.getElementById('viewUserIdInput').value.trim();
            if (!userId) { 
                alert('조회할 사용자 ID를 입력해주세요.'); 
                return; 
            }
            container.innerHTML = '<p>서버에서 주문 정보를 찾는 중...</p>';
            try {
                const response = await fetch(`/api/get-order/${userId}`);
                const data = await response.json();
                if (data.success) {
                    const order = data.order;
                    
                    // ⭐️ QR코드에는 주문자 ID만 담습니다.
                    const qrDataString = order.userId;

                    let itemsHtml = '';
                    for (const storeId in order.cart) {
                        const store = order.cart[storeId];
                        const itemNames = Object.values(store.items).map(item => `${item.name}(${item.quantity}개)`).join(', ');
                        itemsHtml += `<p style="margin: 0.5rem 0;"><strong>${store.storeName}:</strong> ${itemNames}</p>`;
                    }

                    container.innerHTML = `
                        <div id="fetched-qrcode" class="flex justify-center"></div>
                        <h3 style="margin-top: 1rem;">주문자 ID: ${order.userId}</h3>
                        <div style="text-align: left; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                            <h4><strong>주문 내역</strong></h4>
                            ${itemsHtml}
                        </div>
                    `;
                    new QRCode(document.getElementById("fetched-qrcode"), {
                        text: qrDataString,
                        width: 256,
                        height: 256,
                    });
                } else {
                    container.innerHTML = `<p style="color:red;">${data.message}</p>`;
                }
            } catch (error) {
                container.innerHTML = `<p style="color:red;">서버와 통신 중 오류가 발생했습니다.</p>`;
            }
        }
    </script>
</body>
</html>
